# .github/workflows/auto-seo.yml
name: è‡ªå‹•åŒ– SEO å„ªåŒ–

on:
  push:
    branches: [ main ]
    paths:
      - 'index.html'
      - 'Learning/index.html'
      - '*/index.html'
      - 'c-pointer-tutorial/**'
  
  # æ¯é€±ä¹Ÿæœƒè‡ªå‹•åŸ·è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 2 * * 1'  # æ¯é€±ä¸€å‡Œæ™¨ 2 é»ž

jobs:
  auto-seo:
    runs-on: ubuntu-latest
    steps:
    
    # 1. æª¢å‡ºä»£ç¢¼
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ï¼Œç”¨æ–¼æ¯”è¼ƒè®Šæ›´

    # 2. è¨­ç½® Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # 3. è‡ªå‹•ç”Ÿæˆ sitemap.xml
    - name: Generate Sitemap
      run: |
        cat > generate-sitemap.js << 'EOF'
        const fs = require('fs');
        const path = require('path');

        // è‡ªå‹•æŽƒææ‰€æœ‰é‡è¦é é¢
        function scanWebsite() {
          const pages = [
            { url: '/', priority: '1.0', changefreq: 'weekly' },
            { url: '/Learning/', priority: '0.8', changefreq: 'weekly' },
            { url: '/Career/', priority: '0.6', changefreq: 'monthly' },
            { url: '/Travel/', priority: '0.6', changefreq: 'monthly' },
            { url: '/Others/', priority: '0.6', changefreq: 'monthly' }
          ];

          // è‡ªå‹•ç™¼ç¾å°ˆæ¡ˆç›®éŒ„
          const directories = fs.readdirSync('.', { withFileTypes: true })
            .filter(dirent => dirent.isDirectory())
            .map(dirent => dirent.name)
            .filter(name => !name.startsWith('.') && !['node_modules', 'Learning', 'Career', 'Travel', 'Others'].includes(name));

          // æ·»åŠ å°ˆæ¡ˆé é¢
          directories.forEach(dir => {
            if (fs.existsSync(path.join(dir, 'index.html'))) {
              pages.push({
                url: `/${dir}/`,
                priority: '0.9',
                changefreq: 'monthly'
              });
            }
          });

          return pages;
        }

        function generateSitemap() {
          const currentDate = new Date().toISOString().split('T')[0];
          const pages = scanWebsite();
          
          let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
          xml += `<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n`;
          
          pages.forEach(page => {
            xml += `  <url>\n`;
            xml += `    <loc>https://tingnotes.io${page.url}</loc>\n`;
            xml += `    <lastmod>${currentDate}</lastmod>\n`;
            xml += `    <changefreq>${page.changefreq}</changefreq>\n`;
            xml += `    <priority>${page.priority}</priority>\n`;
            xml += `  </url>\n`;
          });
          
          xml += `</urlset>`;
          return xml;
        }

        // ç”Ÿæˆä¸¦å¯«å…¥ sitemap
        const sitemapContent = generateSitemap();
        fs.writeFileSync('sitemap.xml', sitemapContent);
        console.log('âœ… Sitemap generated successfully!');
        EOF

        node generate-sitemap.js

    # 4. ç”Ÿæˆ robots.txt
    - name: Generate robots.txt
      run: |
        cat > robots.txt << 'EOF'
        User-agent: *
        Allow: /

        # é‡è¦è³‡æº
        Allow: /c-pointer-tutorial/
        Allow: /Learning/
        Allow: /Career/
        Allow: /Travel/
        Allow: /Others/

        # Sitemap ä½ç½®
        Sitemap: https://tingnotes.io/sitemap.xml

        # çˆ¬å–å»¶é²ï¼ˆç§’ï¼‰
        Crawl-delay: 1
        EOF

    # 5. æª¢æŸ¥è®Šæ›´ä¸¦æäº¤
    - name: Check for changes
      id: changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Auto SEO Bot"
        
        if [[ `git status --porcelain` ]]; then
          git add sitemap.xml robots.txt
          git commit -m "ðŸ¤– Auto-update SEO files: sitemap.xml & robots.txt"
          git push
          echo "changed=true" >> $GITHUB_OUTPUT
          
          # è¼¸å‡ºè®Šæ›´çš„æª”æ¡ˆç”¨æ–¼å¾ŒçºŒæ­¥é©Ÿ
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        fi

    # 6. è‡ªå‹•æäº¤åˆ° Google Search Console
    - name: Submit to Google Search Console
      if: steps.changes.outputs.changed == 'true'
      env:
        GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
      run: |
        # å®‰è£ Google API å®¢æˆ¶ç«¯
        npm install googleapis

        cat > submit-to-google.js << 'EOF'
        const { google } = require('googleapis');
        const fs = require('fs');

        async function submitToGoogle() {
          try {
            // ä½¿ç”¨æœå‹™å¸³æˆ¶èªè­‰
            const credentials = JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_KEY || '{}');
            
            if (!credentials.client_email) {
              console.log('âš ï¸ Google credentials not configured, skipping Google submission');
              return;
            }

            const auth = new google.auth.GoogleAuth({
              credentials: credentials,
              scopes: ['https://www.googleapis.com/auth/webmasters']
            });

            const searchconsole = google.searchconsole({ version: 'v1', auth });

            // æäº¤ sitemap
            await searchconsole.sitemaps.submit({
              siteUrl: 'https://tingnotes.io',
              feedpath: 'https://tingnotes.io/sitemap.xml'
            });

            console.log('âœ… Sitemap submitted to Google Search Console!');

            // å¦‚æžœæœ‰æ–°çš„é‡è¦é é¢ï¼Œç›´æŽ¥æäº¤ URL
            const changedFiles = fs.readFileSync('changed_files.txt', 'utf8').split('\n').filter(Boolean);
            
            for (const file of changedFiles) {
              if (file.includes('index.html') && !file.includes('.git')) {
                const url = `https://tingnotes.io/${file.replace('/index.html', '/').replace('index.html', '')}`;
                
                try {
                  await searchconsole.urlInspection.index.inspect({
                    inspectionUrl: url,
                    siteUrl: 'https://tingnotes.io'
                  });
                  console.log(`âœ… Submitted URL to Google: ${url}`);
                } catch (error) {
                  console.log(`âš ï¸ Could not submit ${url}: ${error.message}`);
                }
              }
            }

          } catch (error) {
            console.log(`âš ï¸ Google submission failed: ${error.message}`);
            console.log('This is not critical - sitemap will still be discovered naturally');
          }
        }

        submitToGoogle();
        EOF

        node submit-to-google.js

    # 7. Ping æœå°‹å¼•æ“Ž
    - name: Ping Search Engines
      run: |
        echo "ðŸ”” Pinging search engines about sitemap update..."
        
        # Ping Google
        curl -s "https://www.google.com/ping?sitemap=https://tingnotes.io/sitemap.xml" || echo "Google ping failed"
        
        # Ping Bing
        curl -s "https://www.bing.com/ping?sitemap=https://tingnotes.io/sitemap.xml" || echo "Bing ping failed"
        
        echo "âœ… Search engine ping completed!"

    # 8. ç”Ÿæˆå ±å‘Š
    - name: Generate SEO Report
      run: |
        echo "ðŸ“Š SEO è‡ªå‹•åŒ–å ±å‘Š" > seo_report.md
        echo "==================" >> seo_report.md
        echo "" >> seo_report.md
        echo "ðŸ• åŸ·è¡Œæ™‚é–“: $(date)" >> seo_report.md
        echo "ðŸ”— ç¶²ç«™: https://tingnotes.io" >> seo_report.md
        echo "ðŸ“„ Sitemap: https://tingnotes.io/sitemap.xml" >> seo_report.md
        echo "" >> seo_report.md
        
        if [[ -f changed_files.txt ]]; then
          echo "ðŸ“ æœ¬æ¬¡è®Šæ›´æª”æ¡ˆ:" >> seo_report.md
          cat changed_files.txt >> seo_report.md
        fi
        
        echo "" >> seo_report.md
        echo "âœ… è‡ªå‹•åŒ–ä»»å‹™å®Œæˆï¼" >> seo_report.md
        
        cat seo_report.md
